const $=(s,c=document)=>c.querySelector(s),$$=(s,c=document)=>Array.from(c.querySelectorAll(s));
const slides=$('[data-slides]'),prevBtn=$('[data-prev]'),nextBtn=$('[data-next]');
if(prevBtn&&nextBtn&&slides){prevBtn.addEventListener('click',()=>slides.scrollBy({left:-slides.clientWidth*.9,behavior:'smooth'}));nextBtn.addEventListener('click',()=>slides.scrollBy({left:slides.clientWidth*.9,behavior:'smooth'}));}
const cartKey='afiya_cart_v2';let cart=JSON.parse(localStorage.getItem(cartKey)||'[]');
const cartDrawer=$('#cartDrawer'),cartButton=$('#cartButton'),closeCart=$('#closeCart'),cartItems=$('#cartItems'),cartTotal=$('#cartTotal'),cartCount=$('#cartCount'),checkoutBtn=$('#checkoutBtn');
const fmt=n=>'IDR '+n.toLocaleString('id-ID');const save=()=>{localStorage.setItem(cartKey,JSON.stringify(cart));render();};
const add=i=>{const f=cart.find(x=>x.id===i.id);f?f.qty+=1:cart.push({...i,qty:1});save();openCart();};
const qty=(id,d)=>{const i=cart.findIndex(x=>x.id===id);if(i>=0){cart[i].qty+=d;if(cart[i].qty<=0)cart.splice(i,1);save();}};
const delItem=id=>{cart=cart.filter(i=>i.id!==id);save();};
function render(){cartItems.innerHTML='';let total=0,count=0;cart.forEach(it=>{total+=it.price*it.qty;count+=it.qty;const li=document.createElement('li');li.innerHTML=`<img src="${it.img}" alt="${it.name}"><div><div class="item-title">${it.name}</div><div class="item-price">${fmt(it.price)}</div><div class="qty"><button data-act="dec" data-id="${it.id}">−</button><span>${it.qty}</span><button data-act="inc" data-id="${it.id}">+</button><button data-act="del" data-id="${it.id}" style="margin-left:6px">hapus</button></div></div><div>${fmt(it.price*it.qty)}</div>`;cartItems.appendChild(li);});cartTotal.textContent=fmt(total);cartCount.textContent=count;}
const openCart=()=>cartDrawer.classList.add('open'),closeCartDrawer=()=>cartDrawer.classList.remove('open');
cartButton&&cartButton.addEventListener('click',openCart);closeCart&&closeCart.addEventListener('click',closeCartDrawer);
cartDrawer&&cartDrawer.addEventListener('click',e=>{if(e.target.dataset.act==='inc')qty(e.target.dataset.id,1);if(e.target.dataset.act==='dec')qty(e.target.dataset.id,-1);if(e.target.dataset.act==='del')delItem(e.target.dataset.id);});
$$('.btn.add').forEach(b=>b.addEventListener('click',()=>add(JSON.parse(b.getAttribute('data-product')))));
checkoutBtn&&checkoutBtn.addEventListener('click',()=>{if(cart.length===0){alert('Keranjang masih kosong.');return;}const lines=cart.map(i=>`• ${i.name} x${i.qty} — ${fmt(i.price*i.qty)}`);const total=cart.reduce((s,i)=>s+i.price*i.qty,0);const msg=`Halo Afiya Atelier! Saya ingin pesan:\n${lines.join('\n')}\nTotal: ${fmt(total)}\nAlamat toko: jl. bougenvil no.15, jakarta`;const wa=`https://wa.me/6281234567890?text=${encodeURIComponent(msg)}`;window.open(wa,'_blank');});
const f=$('#feedbackForm');f&&f.addEventListener('submit',e=>{e.preventDefault();const d=new FormData(f),body=`Nama: ${d.get('name')}\nEmail: ${d.get('email')}\n\nPesan:\n${d.get('message')}`;window.location.href=`mailto:hello@afiyaatelier.id?subject=Kritik%20%26%20Saran&body=${encodeURIComponent(body)}`;f.reset();});
$('#year')&&($('#year').textContent=new Date().getFullYear());